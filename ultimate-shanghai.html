<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ Ultimate Shanghai Mahjong - éº»é›€å­¦åœ’ãƒãƒˆãƒ«ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Cinzel:wght@400;600&display=swap');
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: radial-gradient(ellipse at center, #0f1419 0%, #1a0b2e 50%, #16213e 100%);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
            margin: 0;
            padding: 0;
        }
        
        .game-container {
            position: relative;
            z-index: 10;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* ğŸ¯ å®Œå…¨ä¸­å¤®é…ç½® */
            padding: 10px;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            animation: fadeInDown 1s ease-out;
        }
        
        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .game-title {
            font-family: 'Cinzel', serif;
            font-size: 32px;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
        }
        
        .game-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            font-weight: 300;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 8px 15px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .stat-value {
            font-weight: 700;
            color: #ffd700;
        }
        
        .game-board {
            position: relative;
            width: calc(100vw - 40px);   /* ç”»é¢å…¨ä½“ã‚’æ´»ç”¨ */
            height: calc(100vh - 160px); /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã‚’è€ƒæ…® */
            max-width: 1400px;           /* é©åˆ‡ãªæœ€å¤§å¹… */
            max-height: 800px;           /* é©åˆ‡ãªæœ€å¤§é«˜ã• */
            min-width: 800px;
            min-height: 500px;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(0, 150, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at center, rgba(20, 30, 48, 0.9) 0%, rgba(36, 59, 85, 0.95) 100%);
            border-radius: 25px;
            margin: 10px auto;
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.2),
                0 0 120px rgba(0, 100, 200, 0.15),
                inset 0 0 60px rgba(255, 255, 255, 0.08),
                0 30px 80px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border: 3px solid;
            border-image: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.4), 
                rgba(0, 150, 255, 0.4), 
                rgba(255, 215, 0, 0.4)) 1;
            
            /* ğŸ† è¶…ç«‹ä½“æ„Ÿ - æ·±ã„perspective */
            perspective: 2000px;
            perspective-origin: 50% 25%;
            transform-style: preserve-3d;
            
            /* âœ¨ è±ªè¯ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            animation: luxuryGlow 4s ease-in-out infinite alternate;
        }
        
        .tile {
            position: absolute;
            width: 60px;  /* ã‚ˆã‚Šå¤§ããªã‚µã‚¤ã‚º */
            height: 80px; /* ã‚ˆã‚Šå¤§ããªã‚µã‚¤ã‚º */
            background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 50%, #e8e8e8 100%);
            border: 1px solid #c8c8c8; /* ã‚ˆã‚Šç´°ã„å¢ƒç•Œç·šã§å¯†ç€æ„Ÿå‘ä¸Š */
            border-radius: 8px; /* ã‚ˆã‚Šå°ã•ãªè§’ä¸¸ã§å¯†ç€æ„Ÿå‘ä¸Š */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            
            /* ğŸ† è¶…ç«‹ä½“æ„Ÿã®ç‰Œ */
            box-shadow: 
                4px 4px 12px rgba(0, 0, 0, 0.4),
                8px 8px 20px rgba(0, 0, 0, 0.2),
                inset 2px 2px 4px rgba(255, 255, 255, 0.9),
                inset -1px -1px 2px rgba(0, 0, 0, 0.1);
            
            /* ğŸ’ ç‰Œã®åšã¿è¡¨ç¾ */
            transform-style: preserve-3d;
            
            /* âœ¨ è»½é‡åŒ–ã•ã‚ŒãŸç«‹ä½“åŠ¹æœ */
            transform-style: preserve-3d;
            filter: drop-shadow(6px 12px 20px rgba(0,0,0,0.6));
        }
        
        /* ğŸ—ï¸ ç¹‹ãŒã£ãŸç‰Œå´é¢è¡¨ç¾ï¼šå³å´é¢ï¼ˆä¸‹ã¾ã§å»¶é•·ã—ã¦è§’ã§æ¥ç¶šï¼‰ */
        .tile::after {
            content: '';
            position: absolute;
            top: 0;
            right: -5px;
            width: 5px;
            height: calc(100% + 5px); /* ä¸‹å´é¢ã¨ç¹‹ãŒã‚‹ã‚ˆã†å»¶é•· */
            background: linear-gradient(to bottom, #8B4513 0%, #8B4513 calc(100% - 5px), #654321 100%);
            border-radius: 0 4px 0 0; /* å³ä¸Šã®ã¿ä¸¸ã */
            z-index: -1;
            transform: skewY(-3deg);
        }
        
        /* ğŸ—ï¸ ç¹‹ãŒã£ãŸç‰Œå´é¢è¡¨ç¾ï¼šä¸‹å´é¢ï¼ˆå³ã¾ã§å»¶é•·ã—ã¦è§’ã§æ¥ç¶šï¼‰ */
        .tile::before {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%; /* å³å´é¢ã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚é€šå¸¸å¹… */
            height: 5px;
            background: linear-gradient(to right, #8B4513 0%, #8B4513 calc(100% - 5px), #654321 100%);
            border-radius: 0 0 0 4px; /* å·¦ä¸‹ã®ã¿ä¸¸ã */
            z-index: -2; /* å³å´é¢ã®ä¸‹ã«é…ç½® */
            transform: skewX(-3deg);
        }
        
        .tile.selectable {
            border-color: #4a7c59;
            background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%);
            cursor: pointer;
        }
        
        .tile.selectable:hover {
            background: linear-gradient(145deg, #f0fff0 0%, #e8ffe8 100%);
            transform: translateY(-2px);
            box-shadow: 
                3px 3px 8px rgba(0, 0, 0, 0.3),
                inset 1px 1px 2px rgba(255, 255, 255, 0.9);
        }
        
        .tile.not-selectable {
            cursor: not-allowed;
            /* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šã™ã¹ã¦ã®ç‰Œã‚’åŒã˜æ˜åº¦ã§è¡¨ç¤º */
            /* filter: brightness(0.7); */
        }
        
        .tile:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 8px 16px rgba(0,0,0,0.3),
                0 0 0 2px rgba(255,215,0,0.6),
                inset 0 2px 4px rgba(255,255,255,0.5);
            filter: brightness(1.08);
        }
        
        .tile.selected {
            transform: translateY(-4px) scale(1.04);
            box-shadow: 
                0 12px 24px rgba(255, 215, 0, 0.4),
                0 0 0 3px rgba(255, 215, 0, 1.0),
                0 0 16px rgba(255, 215, 0, 0.6),
                inset 0 2px 4px rgba(255,255,255,0.7);
            filter: brightness(1.15);
            animation: selectedGlow 1.0s ease-in-out infinite alternate;
        }
        
        @keyframes selectedGlow {
            0% { 
                box-shadow: 
                    0 12px 24px rgba(255, 215, 0, 0.4),
                    0 0 0 3px rgba(255, 215, 0, 1.0),
                    0 0 16px rgba(255, 215, 0, 0.6),
                    inset 0 2px 4px rgba(255,255,255,0.7);
                filter: brightness(1.15);
            }
            100% { 
                box-shadow: 
                    0 16px 32px rgba(255, 215, 0, 0.6),
                    0 0 0 4px rgba(255, 215, 0, 1.0),
                    0 0 24px rgba(255, 215, 0, 0.8),
                    inset 0 3px 6px rgba(255,255,255,0.8);
                filter: brightness(1.25);
            }
        }
        
        .tile.blocked {
            opacity: 1.0; /* ä¸Šæµ·ãƒ‘ã‚ºãƒ«ã®ãƒ«ãƒ¼ãƒ«ï¼šä¸‹ã®ç‰Œã‚’å®Œå…¨ã«éš ã™ */
            cursor: not-allowed;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)) grayscale(0.3);
        }
        
        .tile.matched {
            opacity: 0;
            transform: scale(0) rotateY(180deg);
            pointer-events: none;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn.reset-btn {
            background: linear-gradient(145deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn.hint-btn {
            background: linear-gradient(145deg, #f39c12 0%, #d35400 100%);
            box-shadow: 0 6px 15px rgba(243, 156, 18, 0.3);
        }
        
        .victory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .victory-content {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: victoryPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes victoryPop {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .victory-title {
            font-size: 36px;
            margin-bottom: 15px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* ğŸŒŸ ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes luxuryGlow {
            0% { 
                box-shadow: 
                    0 0 60px rgba(255, 215, 0, 0.2),
                    0 0 120px rgba(0, 100, 200, 0.15),
                    inset 0 0 60px rgba(255, 255, 255, 0.08),
                    0 30px 80px rgba(0, 0, 0, 0.3);
            }
            100% { 
                box-shadow: 
                    0 0 80px rgba(255, 215, 0, 0.3),
                    0 0 160px rgba(0, 150, 255, 0.2),
                    inset 0 0 80px rgba(255, 255, 255, 0.12),
                    0 40px 100px rgba(0, 0, 0, 0.4);
            }
        }
        
        
        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(15px);
        }
        
        .game-over-content {
            background: linear-gradient(145deg, #e74c3c 0%, #c0392b 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.7);
            animation: victoryPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">ğŸ€„ ULTIMATE SHANGHAI MAHJONG ğŸ€„</div>
            
            <div class="game-stats">
                <div class="stat-item">
                    æ®‹ã‚Šç‰Œ: <span class="stat-value" id="remaining">144</span>
                </div>
                <div class="stat-item">
                    è‡ªç”±ãªç‰Œ: <span class="stat-value" id="free-count">0</span>
                </div>
                <div class="stat-item">
                    é¸æŠä¸­: <span class="stat-value" id="selected">ãªã—</span>
                </div>
                <div class="stat-item">
                    ã‚¹ã‚³ã‚¢: <span class="stat-value" id="score">0</span>
                </div>
                <div class="stat-item">
                    ã‚·ãƒ£ãƒƒãƒ•ãƒ«: <span class="stat-value" id="shuffle-remaining">3</span>å›
                </div>
            </div>
        </div>
        
        <div class="game-board" id="game-board">
            <!-- 144æšã®æœ¬æ ¼çš„ãªéº»é›€ç‰Œç”»åƒãŒã“ã“ã«é…ç½®ã•ã‚Œã‚‹ -->
        </div>
        
        <div class="controls">
            <button class="btn reset-btn" onclick="resetGame()">
                ğŸ”„ æ–°ã—ã„ã‚²ãƒ¼ãƒ 
            </button>
            <button class="btn hint-btn" onclick="showHint()">
                ğŸ’¡ ãƒ’ãƒ³ãƒˆ
            </button>
            <button class="btn" onclick="toggleEasyMode()" id="easy-mode-btn">
                ğŸ¯ ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒ¢ãƒ¼ãƒ‰
            </button>
            <button class="btn" onclick="shuffleTiles()" id="shuffle-btn" style="background: linear-gradient(145deg, #f39c12 0%, #d35400 100%);">
                ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ« (<span id="shuffle-count">3</span>å›)
            </button>
        </div>
    </div>
    
    <!-- ğŸ‰ å‹åˆ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="victory-modal" id="victory-modal">
        <div class="victory-content">
            <div class="victory-title">ğŸ† å®Œå…¨å‹åˆ©ï¼ ğŸ†</div>
            <div>å…¨ã¦ã®ç‰Œã‚’é™¤å»ã—ã¾ã—ãŸï¼</div>
            <br>
            <button class="btn" onclick="closeVictoryModal()">ç¶šã‘ã‚‹</button>
        </div>
    </div>
    
    <!-- ğŸ˜µ GAME OVERãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="game-over-modal" id="game-over-modal">
        <div class="game-over-content">
            <div class="victory-title">ğŸ˜µ GAME OVER ğŸ˜µ</div>
            <div id="game-over-message">æ‰‹è©°ã¾ã‚Šã§ã™ï¼</div>
            <br>
            <button class="btn" onclick="closeGameOverModal()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
        </div>
    </div>

    <script>
        // ğŸŒŸ Ultimate Shanghai Mahjong - æœ¬æ ¼ç”»åƒç´ æå¯¾å¿œç‰ˆ
        
        // éº»é›€ç‰Œã®å®šç¾©ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµµæ–‡å­—å¯¾å¿œï¼‰
        const TILE_TYPES = {
            // è¬å­ (1-9) Ã— 4æš = 36æš
            character: [
                { id: 'ms1', name: 'ä¸€è¬', symbol: '1ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms1_1.gif' },
                { id: 'ms2', name: 'äºŒè¬', symbol: '2ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms2_1.gif' },
                { id: 'ms3', name: 'ä¸‰è¬', symbol: '3ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms3_1.gif' },
                { id: 'ms4', name: 'å››è¬', symbol: '4ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms4_1.gif' },
                { id: 'ms5', name: 'äº”è¬', symbol: '5ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms5_1.gif' },
                { id: 'ms6', name: 'å…­è¬', symbol: '6ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms6_1.gif' },
                { id: 'ms7', name: 'ä¸ƒè¬', symbol: '7ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms7_1.gif' },
                { id: 'ms8', name: 'å…«è¬', symbol: '8ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms8_1.gif' },
                { id: 'ms9', name: 'ä¹è¬', symbol: '9ï¸âƒ£', image: 'assets/images/tiles/manzu/p_ms9_1.gif' }
            ],
            // ç­’å­ (1-9) Ã— 4æš = 36æš
            circle: [
                { id: 'ps1', name: 'ä¸€ç­’', symbol: 'ğŸŸ¡', image: 'assets/images/tiles/pinzu/p_ps1_1.gif' },
                { id: 'ps2', name: 'äºŒç­’', symbol: 'ğŸ”µ', image: 'assets/images/tiles/pinzu/p_ps2_1.gif' },
                { id: 'ps3', name: 'ä¸‰ç­’', symbol: 'ğŸŸ¢', image: 'assets/images/tiles/pinzu/p_ps3_1.gif' },
                { id: 'ps4', name: 'å››ç­’', symbol: 'ğŸ”´', image: 'assets/images/tiles/pinzu/p_ps4_1.gif' },
                { id: 'ps5', name: 'äº”ç­’', symbol: 'ğŸŸ ', image: 'assets/images/tiles/pinzu/p_ps5_1.gif' },
                { id: 'ps6', name: 'å…­ç­’', symbol: 'ğŸŸ£', image: 'assets/images/tiles/pinzu/p_ps6_1.gif' },
                { id: 'ps7', name: 'ä¸ƒç­’', symbol: 'âš«', image: 'assets/images/tiles/pinzu/p_ps7_1.gif' },
                { id: 'ps8', name: 'å…«ç­’', symbol: 'âšª', image: 'assets/images/tiles/pinzu/p_ps8_1.gif' },
                { id: 'ps9', name: 'ä¹ç­’', symbol: 'ğŸ”˜', image: 'assets/images/tiles/pinzu/p_ps9_1.gif' }
            ],
            // ç´¢å­ (1-9) Ã— 4æš = 36æš
            bamboo: [
                { id: 'ss1', name: 'ä¸€ç´¢', symbol: 'ğŸ‹', image: 'assets/images/tiles/souzu/p_ss1_1.gif' },
                { id: 'ss2', name: 'äºŒç´¢', symbol: 'ğŸ', image: 'assets/images/tiles/souzu/p_ss2_1.gif' },
                { id: 'ss3', name: 'ä¸‰ç´¢', symbol: 'ğŸ‹', image: 'assets/images/tiles/souzu/p_ss3_1.gif' },
                { id: 'ss4', name: 'å››ç´¢', symbol: 'ğŸ', image: 'assets/images/tiles/souzu/p_ss4_1.gif' },
                { id: 'ss5', name: 'äº”ç´¢', symbol: 'ğŸ‹', image: 'assets/images/tiles/souzu/p_ss5_1.gif' },
                { id: 'ss6', name: 'å…­ç´¢', symbol: 'ğŸ', image: 'assets/images/tiles/souzu/p_ss6_1.gif' },
                { id: 'ss7', name: 'ä¸ƒç´¢', symbol: 'ğŸ‹', image: 'assets/images/tiles/souzu/p_ss7_1.gif' },
                { id: 'ss8', name: 'å…«ç´¢', symbol: 'ğŸ', image: 'assets/images/tiles/souzu/p_ss8_1.gif' },
                { id: 'ss9', name: 'ä¹ç´¢', symbol: 'ğŸ‹', image: 'assets/images/tiles/souzu/p_ss9_1.gif' }
            ],
            // å­—ç‰Œ (æ±å—è¥¿åŒ—ç™½ç™¼ä¸­) Ã— 4æš = 28æš
            honor: [
                { id: 'ji_e', name: 'æ±', symbol: 'ğŸŒ…', image: 'assets/images/tiles/jihai/p_ji_e_1.gif' },
                { id: 'ji_s', name: 'å—', symbol: 'â˜€ï¸', image: 'assets/images/tiles/jihai/p_ji_s_1.gif' },
                { id: 'ji_w', name: 'è¥¿', symbol: 'ğŸŒ„', image: 'assets/images/tiles/jihai/p_ji_w_1.gif' },
                { id: 'ji_n', name: 'åŒ—', symbol: 'â­', image: 'assets/images/tiles/jihai/p_ji_n_1.gif' },
                { id: 'ji_h', name: 'ç™½', symbol: 'â¬œ', image: 'assets/images/tiles/jihai/p_ji_h_1.gif' },
                { id: 'ji_c', name: 'ä¸­', symbol: 'ğŸ”´', image: 'assets/images/tiles/jihai/p_ji_c_1.gif' },
                { id: 'ji_no', name: 'ç™¼', symbol: 'ğŸŸ¢', image: 'assets/images/tiles/jihai/p_no_1.gif' }
            ],
            // èŠ±ç‰Œãƒ»å­£ç¯€ç‰Œ Ã— 1æš = 8æš
            flower: [
                { id: 'flower1', name: 'èŠ±1', symbol: 'ğŸŒ¸', image: 'assets/images/tiles/flower/flower.gif' },
                { id: 'flower2', name: 'èŠ±2', symbol: 'ğŸŒº', image: 'assets/images/tiles/flower/flower.gif' },
                { id: 'flower3', name: 'èŠ±3', symbol: 'ğŸŒ»', image: 'assets/images/tiles/flower/flower.gif' },
                { id: 'flower4', name: 'èŠ±4', symbol: 'ğŸŒ·', image: 'assets/images/tiles/flower/flower.gif' },
                { id: 'season1', name: 'å­£1', symbol: 'ğŸƒ', image: 'assets/images/tiles/flower/flower.gif' },
                { id: 'season2', name: 'å­£2', symbol: 'ğŸ‚', image: 'assets/images/tiles/flower/flower.gif' },
                { id: 'season3', name: 'å­£3', symbol: 'â„ï¸', image: 'assets/images/tiles/flower/flower.gif' },
                { id: 'season4', name: 'å­£4', symbol: 'â˜€ï¸', image: 'assets/images/tiles/flower/flower.gif' }
            ]
        };
        
        // ğŸ¯ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå®Œå…¨ç§»æ¤ï¼šæœ¬æ ¼ä¸Šæµ·ãƒ‘ã‚ºãƒ«144æšé…ç½®
        // åˆ†æçµæœã«åŸºã¥ãå®Œç’§ãªåå­—å‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
        const TURTLE_LAYOUT_POSITIONS = [
            // === ç¬¬1å±¤ï¼ˆåŸºç›¤å±¤ï¼‰ï¼š68æš ===
            // ä¸Šéƒ¨æ¨ªåˆ—ï¼ˆ12æšï¼‰
            {x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},{x:5,y:0},{x:6,y:0},{x:7,y:0},{x:8,y:0},{x:9,y:0},{x:10,y:0},{x:11,y:0},{x:12,y:0},
            // ä¸Šéƒ¨ç¸¦åˆ—ã®ä¸¡ç«¯ï¼ˆ2æšï¼‰
            {x:1,y:1},{x:12,y:1},
            // ä¸­å¤®éƒ¨åˆ†ã®æ¨ªåˆ—ï¼ˆ12æšï¼‰
            {x:1,y:2},{x:2,y:2},{x:3,y:2},{x:4,y:2},{x:5,y:2},{x:6,y:2},{x:7,y:2},{x:8,y:2},{x:9,y:2},{x:10,y:2},{x:11,y:2},{x:12,y:2},
            // ä¸­å¤®å·¦å³ï¼ˆ10æšÃ—2åˆ—ï¼‰
            {x:2,y:3},{x:3,y:3},{x:4,y:3},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:8,y:3},{x:9,y:3},{x:10,y:3},{x:11,y:3},
            {x:2,y:4},{x:3,y:4},{x:4,y:4},{x:5,y:4},{x:6,y:4},{x:7,y:4},{x:8,y:4},{x:9,y:4},{x:10,y:4},{x:11,y:4},
            // ä¸‹éƒ¨ä¸­å¤®ï¼ˆ12æšï¼‰
            {x:1,y:5},{x:2,y:5},{x:3,y:5},{x:4,y:5},{x:5,y:5},{x:6,y:5},{x:7,y:5},{x:8,y:5},{x:9,y:5},{x:10,y:5},{x:11,y:5},{x:12,y:5},
            // ä¸‹éƒ¨ç¸¦åˆ—ã®ä¸¡ç«¯ï¼ˆ2æšï¼‰
            {x:1,y:6},{x:12,y:6},
            // æœ€ä¸‹éƒ¨æ¨ªåˆ—ï¼ˆ12æšï¼‰
            {x:1,y:7},{x:2,y:7},{x:3,y:7},{x:4,y:7},{x:5,y:7},{x:6,y:7},{x:7,y:7},{x:8,y:7},{x:9,y:7},{x:10,y:7},{x:11,y:7},{x:12,y:7},

            // === ç¬¬2å±¤ï¼š36æš ===
            // ä¸Šéƒ¨ï¼ˆ10æšï¼‰
            {x:2,y:1,z:1},{x:3,y:1,z:1},{x:4,y:1,z:1},{x:5,y:1,z:1},{x:6,y:1,z:1},{x:7,y:1,z:1},{x:8,y:1,z:1},{x:9,y:1,z:1},{x:10,y:1,z:1},{x:11,y:1,z:1},
            // ä¸­å¤®éƒ¨ï¼ˆ8æšÃ—3åˆ—ï¼‰
            {x:3,y:2,z:1},{x:4,y:2,z:1},{x:5,y:2,z:1},{x:6,y:2,z:1},{x:7,y:2,z:1},{x:8,y:2,z:1},{x:9,y:2,z:1},{x:10,y:2,z:1},
            {x:3,y:3,z:1},{x:4,y:3,z:1},{x:5,y:3,z:1},{x:6,y:3,z:1},{x:7,y:3,z:1},{x:8,y:3,z:1},{x:9,y:3,z:1},{x:10,y:3,z:1},
            {x:3,y:4,z:1},{x:4,y:4,z:1},{x:5,y:4,z:1},{x:6,y:4,z:1},{x:7,y:4,z:1},{x:8,y:4,z:1},{x:9,y:4,z:1},{x:10,y:4,z:1},
            // ä¸‹éƒ¨ï¼ˆ10æšï¼‰
            {x:2,y:6,z:1},{x:3,y:6,z:1},{x:4,y:6,z:1},{x:5,y:6,z:1},{x:6,y:6,z:1},{x:7,y:6,z:1},{x:8,y:6,z:1},{x:9,y:6,z:1},{x:10,y:6,z:1},{x:11,y:6,z:1},

            // === ç¬¬3å±¤ï¼š24æš ===
            // ä¸Šä¸‹å„6æšã€ä¸­å¤®2åˆ—å„6æš
            {x:4,y:2,z:2},{x:5,y:2,z:2},{x:6,y:2,z:2},{x:7,y:2,z:2},{x:8,y:2,z:2},{x:9,y:2,z:2},
            {x:4,y:3,z:2},{x:5,y:3,z:2},{x:6,y:3,z:2},{x:7,y:3,z:2},{x:8,y:3,z:2},{x:9,y:3,z:2},
            {x:4,y:4,z:2},{x:5,y:4,z:2},{x:6,y:4,z:2},{x:7,y:4,z:2},{x:8,y:4,z:2},{x:9,y:4,z:2},
            {x:4,y:5,z:2},{x:5,y:5,z:2},{x:6,y:5,z:2},{x:7,y:5,z:2},{x:8,y:5,z:2},{x:9,y:5,z:2},

            // === ç¬¬4å±¤ï¼š12æš ===
            // ä¸­å¤®4Ã—3åˆ—
            {x:5,y:3,z:3},{x:6,y:3,z:3},{x:7,y:3,z:3},{x:8,y:3,z:3},
            {x:5,y:4,z:3},{x:6,y:4,z:3},{x:7,y:4,z:3},{x:8,y:4,z:3},
            {x:5,y:5,z:3},{x:6,y:5,z:3},{x:7,y:5,z:3},{x:8,y:5,z:3},

            // === ç¬¬5å±¤ï¼ˆæœ€ä¸Šå±¤ï¼‰ï¼š4æš ===
            // ä¸­å¤®2Ã—2
            {x:6,y:3,z:4},{x:7,y:3,z:4},{x:6,y:4,z:4},{x:7,y:4,z:4}
        ];
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameBoard = new Map();
        let selectedTiles = [];
        let matchedTiles = new Set();
        let easyMode = false;
        let score = 0;
        let shuffleCount = 0; // ã‚·ãƒ£ãƒƒãƒ•ãƒ«å›æ•°ï¼ˆæœ€å¤§3å›ï¼‰
        let isGameOver = false;
        
        // ç‰Œç”Ÿæˆï¼ˆç´ æå¯¾å¿œï¼‰
        function generateTileSet() {
            const tiles = [];
            let tileId = 0;
            
            for (const [category, tileData] of Object.entries(TILE_TYPES)) {
                for (const tile of tileData) {
                    let copies = (category === 'flower') ? 1 : 4;
                    for (let copy = 0; copy < copies; copy++) {
                        tiles.push({
                            id: tileId++,
                            symbol: tile.symbol || tile.name,
                            color: tile.color,
                            image: tile.image,
                            tileId: tile.id,
                            category: category,
                            matched: false
                        });
                    }
                }
            }
            
            return shuffleArray(tiles);
        }
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // ç°¡ç•¥åŒ–ï¼šå…¨ã¦ã®ç‰Œã‚’æ­£æ–¹å‘ï¼ˆ_1.gifï¼‰ã§çµ±ä¸€
        function getTileOrientation(tile) {
            // å…¨ã¦æ­£æ–¹å‘ã®ã¿ã‚’ä½¿ç”¨ï¼ˆ8ç¨®ã®å‘ãã‚·ã‚¹ãƒ†ãƒ ã‚’ç°¡ç•¥åŒ–ï¼‰
            return 1;
        }
        
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ï¼ˆå‚è€ƒã‚³ãƒ¼ãƒ‰åŸºç›¤ï¼‰
        function initGame() {
            gameBoard.clear();
            selectedTiles = [];
            matchedTiles.clear();
            score = 0;
            shuffleCount = 0;
            isGameOver = false;
            
            const tileSet = generateTileSet();
            
            // å‚è€ƒã‚³ãƒ¼ãƒ‰ã®åº§æ¨™ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
            TURTLE_LAYOUT_POSITIONS.forEach((pos, index) => {
                if (index < tileSet.length) {
                    const tile = {
                        ...tileSet[index],
                        x: pos.x,
                        y: pos.y,
                        z: pos.z || 0
                    };
                    gameBoard.set(`${pos.x},${pos.y},${pos.z || 0}`, tile);
                }
            });
            
            renderBoard();
            updateStats();
            
            console.log(`ğŸ¯ ${gameBoard.size}æšã®ç‰Œã‚’é…ç½®å®Œäº† (ç›®æ¨™: 144æš)`);
            console.log(`ğŸ“Š TURTLE_LAYOUT_POSITIONS.length = ${TURTLE_LAYOUT_POSITIONS.length}`);
        }
        
        // å‚è€ƒã‚³ãƒ¼ãƒ‰åŸºç›¤ã®ç¢ºå®Ÿãªé¸æŠå¯èƒ½æ€§åˆ¤å®šï¼ˆé€æ˜åº¦ãªã—ï¼‰
        function isTileFree(tile) {
            if (!tile || matchedTiles.has(tile.id)) return false;
            
            // ä¸Šã«ç‰ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const covered = Array.from(gameBoard.values()).some(t => 
                !matchedTiles.has(t.id) && t.id !== tile.id &&
                t.x === tile.x && t.y === tile.y && t.z === tile.z + 1
            );
            if (covered) return false;
            
            // å·¦å³ã«ç‰ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const leftBlocked = Array.from(gameBoard.values()).some(t =>
                !matchedTiles.has(t.id) && t.id !== tile.id &&
                t.x === tile.x - 1 && t.y === tile.y && t.z === tile.z
            );
            const rightBlocked = Array.from(gameBoard.values()).some(t =>
                !matchedTiles.has(t.id) && t.id !== tile.id &&
                t.x === tile.x + 1 && t.y === tile.y && t.z === tile.z
            );
            
            return !leftBlocked || !rightBlocked;
        }
        
        // ğŸ” ç‰ŒãŒç‰©ç†çš„ã«å®Œå…¨ã«éš ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function isPhysicallyHidden(tile) {
            if (!tile || matchedTiles.has(tile.id)) return false;
            
            const { x, y, z } = tile;
            
            // ç›´æ¥ä¸Šã«è¤‡æ•°ã®ç‰ŒãŒã‚ã‚‹å ´åˆã¯å®Œå…¨ã«éš ã‚Œã‚‹
            let coverCount = 0;
            for (let layer = z + 1; layer <= 4; layer++) {
                const above = gameBoard.get(`${x},${y},${layer}`);
                if (above && !matchedTiles.has(above.id)) {
                    coverCount++;
                }
            }
            
            // 2å±¤ä»¥ä¸Šé‡ãªã£ã¦ã„ã‚‹ã€ã¾ãŸã¯æœ€ä¸‹å±¤ã§å‘¨å›²ãŒå®Œå…¨ã«å›²ã¾ã‚Œã¦ã„ã‚‹
            if (coverCount >= 2) return true;
            
            // æœ€ä¸‹å±¤ï¼ˆz=0ï¼‰ã§å®Œå…¨ã«å››æ–¹ã‚’å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
            if (z === 0) {
                const neighbors = [
                    gameBoard.get(`${x-1},${y},${z}`),
                    gameBoard.get(`${x+1},${y},${z}`),
                    gameBoard.get(`${x},${y-1},${z}`),
                    gameBoard.get(`${x},${y+1},${z}`)
                ];
                
                const blockedSides = neighbors.filter(n => n && !matchedTiles.has(n.id)).length;
                return blockedSides >= 3; // 3æ–¹å‘ä»¥ä¸Šå›²ã¾ã‚Œã¦ã„ã‚Œã°éš ã‚Œã‚‹
            }
            
            return false;
        }
        
        // ğŸ¯ ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
        function calculateDynamicScale() {
            const boardElement = document.getElementById('game-board');
            const boardWidth = boardElement.offsetWidth;
            const boardHeight = boardElement.offsetHeight;
            
            // ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å‹•çš„è¨ˆç®—
            const scaleX = Math.max(boardWidth / 800, 0.5); // æœ€å°50%
            const scaleY = Math.max(boardHeight / 600, 0.5); // æœ€å°50%
            const scale = Math.min(scaleX, scaleY); // å°ã•ã„æ–¹ã‚’æ¡ç”¨
            
            return {
                tileSpaceX: Math.max(25 * scale, 20),
                tileSpaceY: Math.max(35 * scale, 25),
                layerOffset: Math.max(12 * scale, 8),
                centerOffsetX: boardWidth / 2,
                centerOffsetY: boardHeight / 2
            };
        }

        // å‚è€ƒã‚³ãƒ¼ãƒ‰åŸºç›¤ã®ç¢ºå®Ÿãªæç”»ã‚·ã‚¹ãƒ†ãƒ ï¼ˆé€æ˜åº¦ãªã—ï¼‰
        function renderBoard() {
            const boardElement = document.getElementById('game-board');
            boardElement.innerHTML = '';
            
            console.log(`ğŸ“Š ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ç·ç‰Œæ•°: ${gameBoard.size}æš (ç›®æ¨™: 144æš)`);
            
            // ğŸ¯ ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨
            const scale = calculateDynamicScale();
            
            for (const [key, tile] of gameBoard.entries()) {
                if (matchedTiles.has(tile.id)) continue;
                
                const tileElement = document.createElement('div');
                tileElement.className = 'tile';
                tileElement.dataset.tileId = tile.id;
                
                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå‚è€ƒï¼šæœ¬æ ¼ä¸Šæµ·ãƒ‘ã‚ºãƒ«é…ç½®ã®å®Œå…¨å†ç¾
                const boardElement = document.getElementById('game-board');
                const boardCenterX = boardElement.offsetWidth / 2;
                const boardCenterY = boardElement.offsetHeight / 2;
                
                // éš£æ¥ç‰Œã‚’å®Œå…¨ã«å¯†ç€ã•ã›ã‚‹ï¼ˆé–“éš”ã‚¼ãƒ­ï¼‰
                const tileSpacingX = 60; // ç‰Œ60px + é–“éš”0pxï¼ˆå®Œå…¨å¯†ç€ï¼‰
                const tileSpacingY = 80; // ç‰Œ80px + é–“éš”0pxï¼ˆå®Œå…¨å¯†ç€ï¼‰
                
                // ä¸Šå±¤ã®ç«‹ä½“ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆé€šã‚Šï¼‰
                const layerOffsetX = tile.z * 6;
                const layerOffsetY = tile.z * 6;
                
                // ä¸­å¤®é…ç½®è¨ˆç®—
                const totalWidth = 15 * tileSpacingX; // æœ€å¤§å¹…15ç‰Œ
                const totalHeight = 8 * tileSpacingY; // æœ€å¤§é«˜8ç‰Œ
                
                const x = boardCenterX - (totalWidth / 2) + (tile.x * tileSpacingX) - layerOffsetX;
                const y = boardCenterY - (totalHeight / 2) + (tile.y * tileSpacingY) - layerOffsetY;
                
                tileElement.style.left = `${x}px`;
                tileElement.style.top = `${y}px`;
                
                // ç¢ºå®Ÿãªz-indexè¨ˆç®—ï¼ˆå‚è€ƒã‚³ãƒ¼ãƒ‰åŸºç›¤ï¼‰
                tileElement.style.zIndex = tile.x + tile.y * 100 + tile.z * 10000;
                
                // ğŸ¯ å¼·åˆ¶çš„ãªç”»åƒè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ä»˜ãï¼‰
                console.log(`ğŸ–¼ï¸ ç‰Œç”»åƒ: ${tile.name} -> ${tile.image}`);
                
                if (tile.image) {
                    // ç›´æ¥imgã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¦ç¢ºå®Ÿãªç”»åƒè¡¨ç¤º
                    const imgElement = document.createElement('img');
                    imgElement.src = tile.image;
                    imgElement.style.width = '100%';
                    imgElement.style.height = '100%';
                    imgElement.style.objectFit = 'contain';
                    imgElement.style.display = 'block';
                    imgElement.alt = tile.name;
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    imgElement.onerror = function() {
                        console.log(`âŒ ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${tile.image}`);
                        this.style.display = 'none';
                        tileElement.textContent = tile.symbol || tile.name || 'ğŸ€„';
                        tileElement.style.fontSize = '28px';
                        tileElement.style.fontWeight = 'bold';
                        tileElement.style.color = '#333';
                        tileElement.style.textAlign = 'center';
                        tileElement.style.lineHeight = '50px';
                    };
                    
                    imgElement.onload = function() {
                        console.log(`âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ: ${tile.image}`);
                    };
                    
                    tileElement.textContent = '';
                    tileElement.appendChild(imgElement);
                } else {
                    console.log(`âš ï¸ ç”»åƒãªã—ã€çµµæ–‡å­—è¡¨ç¤º: ${tile.name}`);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµµæ–‡å­—è¡¨ç¤ºï¼ˆã‚ˆã‚Šå¤§ããï¼‰
                    tileElement.textContent = tile.symbol || tile.name || 'ğŸ€„';
                    tileElement.style.fontSize = '28px';
                    tileElement.style.fontWeight = 'bold';
                    tileElement.style.color = '#333';
                    tileElement.style.textAlign = 'center';
                    tileElement.style.lineHeight = '50px';
                    tileElement.style.display = 'flex';
                    tileElement.style.alignItems = 'center';
                    tileElement.style.justifyContent = 'center';
                }
                
                // å‚è€ƒã‚³ãƒ¼ãƒ‰åŸºç›¤ã®é¸æŠå¯èƒ½æ€§åˆ¤å®šï¼ˆé€æ˜åº¦ãªã—ï¼‰
                const selectable = isTileFree(tile);
                tileElement.classList.toggle('selectable', selectable);
                tileElement.classList.toggle('not-selectable', !selectable);
                
                // é¸æŠçŠ¶æ…‹
                if (selectedTiles.some(t => t.id === tile.id)) {
                    tileElement.classList.add('selected');
                }
                
                tileElement.addEventListener('click', (e) => handleTileClick(tile, e));
                boardElement.appendChild(tileElement);
            }
        }
        
        // ã‚¿ã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleTileClick(tile, event) {
            if (!isTileFree(tile)) {
                return;
            }
            
            const alreadySelected = selectedTiles.findIndex(t => t.id === tile.id);
            
            if (alreadySelected >= 0) {
                selectedTiles.splice(alreadySelected, 1);
            } else if (selectedTiles.length < 2) {
                selectedTiles.push(tile);
                
                if (selectedTiles.length === 2) {
                    setTimeout(checkMatch, 500);
                }
            }
            
            renderBoard();
            updateStats();
        }
        
        // ãƒãƒƒãƒãƒ³ã‚°åˆ¤å®š
        function checkMatch() {
            const [tile1, tile2] = selectedTiles;
            
            const isMatch = (tile1.tileId && tile1.tileId === tile2.tileId) || 
                           (tile1.symbol === tile2.symbol) ||
                           (tile1.category === 'flower' && tile2.category === 'flower');
            
            if (isMatch) {
                score += 100;
                matchedTiles.add(tile1.id);
                matchedTiles.add(tile2.id);
                
                // å‹åˆ©åˆ¤å®š
                if (matchedTiles.size === gameBoard.size) {
                    setTimeout(showVictory, 1000);
                }
                
                console.log('âœ… ãƒãƒƒãƒæˆåŠŸï¼ ã‚¹ã‚³ã‚¢:', score);
            } else {
                console.log('âŒ ãƒãƒƒãƒå¤±æ•—');
            }
            
            selectedTiles = [];
            renderBoard();
            updateStats();
        }
        
        // å‹åˆ©è¡¨ç¤º
        function showVictory() {
            document.getElementById('victory-modal').style.display = 'flex';
        }
        
        function closeVictoryModal() {
            document.getElementById('victory-modal').style.display = 'none';
            resetGame();
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            document.getElementById('remaining').textContent = gameBoard.size - matchedTiles.size;
            document.getElementById('score').textContent = score;
            
            let freeCount = 0;
            for (const [key, tile] of gameBoard.entries()) {
                if (isTileFree(tile)) freeCount++;
            }
            document.getElementById('free-count').textContent = freeCount;
            
            document.getElementById('selected').textContent = 
                selectedTiles.length > 0 ? `${selectedTiles.length}æš` : 'ãªã—';
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«å›æ•°è¡¨ç¤ºæ›´æ–°
            const remaining = 3 - shuffleCount;
            document.getElementById('shuffle-remaining').textContent = remaining;
            document.getElementById('shuffle-count').textContent = remaining;
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            const shuffleBtn = document.getElementById('shuffle-btn');
            if (remaining <= 0) {
                shuffleBtn.style.opacity = '0.5';
                shuffleBtn.style.cursor = 'not-allowed';
            } else if (isGameStuck()) {
                shuffleBtn.style.boxShadow = '0 0 20px rgba(243, 156, 18, 0.8)';
                shuffleBtn.style.animation = 'pulse 1s infinite';
            } else {
                shuffleBtn.style.boxShadow = '0 6px 15px rgba(243, 156, 18, 0.3)';
                shuffleBtn.style.animation = 'none';
            }
        }
        
        // ã™ã¹ã¦ã®ãƒãƒƒãƒã‚’æ¤œç´¢
        function findAllMatches() {
            const freeTiles = [];
            for (const [key, tile] of gameBoard.entries()) {
                if (isTileFree(tile)) freeTiles.push(tile);
            }
            
            const matches = [];
            for (let i = 0; i < freeTiles.length; i++) {
                for (let j = i + 1; j < freeTiles.length; j++) {
                    const tile1 = freeTiles[i];
                    const tile2 = freeTiles[j];
                    
                    const isMatch = (tile1.tileId && tile1.tileId === tile2.tileId) || 
                                   (tile1.symbol === tile2.symbol) ||
                                   (tile1.category === 'flower' && tile2.category === 'flower');
                    
                    if (isMatch) {
                        matches.push([tile1, tile2]);
                    }
                }
            }
            
            return matches;
        }
        
        // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
        function showHint() {
            const matches = findAllMatches();
            
            if (matches.length > 0) {
                const [tile1, tile2] = matches[0];
                alert(`ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ${tile1.symbol || tile1.name} ã¨ ${tile2.symbol || tile2.name} ãŒãƒãƒƒãƒã—ã¾ã™`);
            } else {
                alert('ğŸ’¡ ãƒãƒƒãƒå¯èƒ½ãªãƒšã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleEasyMode() {
            easyMode = !easyMode;
            const btn = document.getElementById('easy-mode-btn');
            btn.textContent = easyMode ? 'ğŸ”¥ ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰' : 'ğŸ¯ ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒ¢ãƒ¼ãƒ‰';
            btn.style.background = easyMode ? 
                'linear-gradient(145deg, #e74c3c 0%, #c0392b 100%)' : 
                'linear-gradient(145deg, #27ae60 0%, #229954 100%)';
            renderBoard();
        }
        
        // æ‰‹è©°ã¾ã‚Šæ¤œå‡º
        function isGameStuck() {
            if (isGameOver || matchedTiles.size === gameBoard.size) return false;
            
            const matches = findAllMatches();
            return matches.length === 0;
        }
        
        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ©Ÿèƒ½ï¼ˆæ‰‹è©°ã¾ã‚Šæ™‚ï¼‰
        function shuffleTiles() {
            if (shuffleCount >= 3) {
                showGameOver('ğŸš« ã‚·ãƒ£ãƒƒãƒ•ãƒ«å›æ•°ä¸Šé™ã§ã™ï¼GAME OVER');
                return;
            }
            
            if (!isGameStuck()) {
                alert('ğŸ¯ ã¾ã ãƒãƒƒãƒå¯èƒ½ãªç‰ŒãŒã‚ã‚Šã¾ã™');
                return;
            }
            
            shuffleCount++;
            
            // æœªãƒãƒƒãƒã®ç‰Œã‚’åé›†
            const remainingTiles = [];
            for (const [key, tile] of gameBoard.entries()) {
                if (!matchedTiles.has(tile.id)) {
                    remainingTiles.push({ key, tile });
                }
            }
            
            // ç‰Œã®ç¨®é¡ã ã‘ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const tileTypes = remainingTiles.map(item => ({
                tileId: item.tile.tileId,
                symbol: item.tile.symbol,
                color: item.tile.color,
                image: item.tile.image,
                category: item.tile.category,
                name: item.tile.name
            }));
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = tileTypes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tileTypes[i], tileTypes[j]] = [tileTypes[j], tileTypes[i]];
            }
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãŸç¨®é¡ã‚’å†é…ç½®
            remainingTiles.forEach((item, index) => {
                gameBoard.get(item.key).tileId = tileTypes[index].tileId;
                gameBoard.get(item.key).symbol = tileTypes[index].symbol;
                gameBoard.get(item.key).color = tileTypes[index].color;
                gameBoard.get(item.key).image = tileTypes[index].image;
                gameBoard.get(item.key).category = tileTypes[index].category;
                gameBoard.get(item.key).name = tileTypes[index].name;
            });
            
            renderBoard();
            updateStats();
            
            console.log(`ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«å®Ÿè¡Œ (${shuffleCount}/3)`);
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã‚‚æ‰‹è©°ã¾ã‚Šãªã‚‰GAME OVER
            setTimeout(() => {
                if (isGameStuck()) {
                    if (shuffleCount >= 3) {
                        showGameOver('ğŸ˜µ ã‚·ãƒ£ãƒƒãƒ•ãƒ«3å›å¾Œã‚‚æ‰‹è©°ã¾ã‚Šã§ã™ï¼GAME OVER');
                    }
                }
            }, 1000);
        }
        
        // GAME OVERè¡¨ç¤º
        function showGameOver(message) {
            isGameOver = true;
            document.getElementById('game-over-message').textContent = message;
            document.getElementById('game-over-modal').style.display = 'flex';
        }
        
        function closeGameOverModal() {
            document.getElementById('game-over-modal').style.display = 'none';
            resetGame();
        }
        
        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetGame() {
            initGame();
        }
        
        // ğŸ¯ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
            setTimeout(() => {
                renderBoard();
                updateStats();
                console.log('ğŸ–¼ï¸ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºã«å¯¾å¿œã—ã¾ã—ãŸ');
            }, 100); // 100msé…å»¶ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
        });

        // ğŸ¯ ã‚²ãƒ¼ãƒ é–‹å§‹
        console.log('ğŸš€ Ultimate Shanghai Mahjong - æœ¬æ ¼ç”»åƒç´ æå¯¾å¿œç‰ˆ');
        
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        initGame();
        
        console.log('âœ¨ æœ¬æ ¼çš„éº»é›€ç‰Œç´ æã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>